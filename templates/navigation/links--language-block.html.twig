{% if links %}
  <div {{ attributes.addClass('language-switcher', 'js-language-switcher') }}>
    <div class="language-links">
      {% for item in links %}
        {% set language_link = '' %}
        {% set lang = item.link['#options']['#abbreviation'] %}
        {% set untranslated = item.link['#options']['#untranslated'] %}
        {% set nolink = item.link['#options']['#nolink'] %}
        {% set alternative_language = not item.link['#options']['#primary_language'] %}
        {% set classes = ['language-link'] %}
        {% set ariaCurrent = null %}
        {% set is_active = false %}

        {# Check if link is part of alternative menu and set class accordingly. #}
        {% set classes = classes|merge([alternative_language ? 'is-alternative' : '']) %}

        {% if not untranslated and not alternative_language and lang != language.id %}
          {% set is_active = true %}
        {% elseif lang == language.id and not nolink %}
          {% set is_active = true %}
          {% set ariaCurrent = create_attribute({'aria-current': 'true'}) %}
          {% set classes = classes|merge(['is-disabled']) %}
        {% else %}
          {% set button_wrapper_classes = ['nav-toggle--language-toast', 'nav-toggle--language-toast--' ~ lang] %}
          {% set anchor_button_classes = ['is-disabled', 'has-toast', alternative_language ? 'is-alternative' : ''] %}
          {% set dropdown_wrapper_classes = ['nav-toggle-dropdown--language-toast', 'nav-toggle-dropdown--language-toast--' ~ lang] %}
          {% if lang == 'en' %}
            {% set text = "This page is not available in English. Go to the homepage to access the website's English-language content." %}
            {% set link_title = 'Return to the front page' %}
            {% set link_attributes = {'class': ['language-toast__link']} %}
          {% elseif lang == 'fi' %}
            {% set text = "Tätä sivua ei ole suomeksi. Löydät muuta suomenkielistä sisältöä etusivun kautta." %}
            {% set link_title = 'Siirry etusivulle' %}
            {% set link_attributes = {'class': ['language-toast__link']} %}
          {% elseif lang == 'sv' %}
            {% set text = "Denna sida finns inte på svenska. Gå till startsidan för att se annat material på svenska." %}
            {% set link_title = 'Gå till startsidan' %}
            {% set link_attributes = {'class': ['language-toast__link']} %}
          {% endif %}
        {% endif %}

        {% if is_active %}
          <span class="language-link__wrapper">
            <a
              {{ create_attribute({'class': classes}) }}
              {{ create_attribute({'href': path('<current>', {}, {'language': item.link['#options']['language']})}) }}
              {{ create_attribute({'lang': lang}) }}
              {{ ariaCurrent }}
            >{{ item.text|capitalize }}
            </a>
          </span>

        {# Hide the alterative languages from the html structure since they cause all sorts of trouble in the layout. #}
        {% elseif not alternative_language %}
          {% set dropdown_id = 'language-toast--' ~ lang ~ '-dropdown' %}
          <span class="language-link__wrapper">
            {% embed "@hdbt/misc/nav-toggle-button.twig" with {
              modifier_class: button_wrapper_classes,
              anchor_modified: anchor_button_classes,
              button_modified: anchor_button_classes,
              controls: dropdown_id,
              anchor_target: '#language-toast--' ~ lang,
              js_target: 'js-language-toast--' ~ lang ~ '-button',
              open_label: item.text|capitalize,
              close_label: item.text|capitalize,
            } %}
            {% endembed %}
            {% embed "@hdbt/misc/nav-toggle-dropdown.twig" with {
              id: dropdown_id,
              modifier_class: dropdown_wrapper_classes,
              js_target: 'js-language-toast--' ~ lang ~ '-dropdown',
            } %}
              {% block content%}
                <div class="language-toast" id="language-toast--{{ lang }}">
                  {% set language_toast_close_labelled_by = "language-toast__close__aria-label--" ~ random() %}
                  <button class="language-toast__close js-language-toast--{{ lang }}-button" aria-labelledby="{{ language_toast_close_labelled_by }}" aria-expanded="false" aria-controls="{{ dropdown_id }}">
                    <span id="{{language_toast_close_labelled_by}}" class="is-hidden">{{ 'Close the popup'|t({}, {'context': 'Language toast'}) }}</span>
                  </button>
                  <div class="language-toast__content" lang="{{ lang }}">
                    <div class="language-toast__text">
                      {{ text }}
                    </div>
                    {{ link(link_title, 'internal:/' ~ path('<front>'), link_attributes) }}
                  </div>
                </div>
              {% endblock %}
            {% endembed %}
          </span>
        {% endif %}

      {% endfor %}
    </div>
  </div>
{% endif %}
